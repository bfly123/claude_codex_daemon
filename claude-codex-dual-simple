#!/usr/bin/env python3
"""
Claude-Codex åŒçª—å£æ¨¡å¼ - ç®€åŒ–ç‰ˆ
ä¸“æ³¨äºtmuxæ¨¡å¼ï¼Œé¿å…ç»ˆç«¯å…¼å®¹æ€§é—®é¢˜
"""

import sys
import os
import json
import time
import subprocess
import signal
import atexit
import argparse
import getpass
from pathlib import Path

class SimpleClaudeCodexDual:
    def __init__(self, resume=False, claude_args=None):
        self.resume = resume
        self.claude_args = claude_args or []
        self.script_dir = Path(__file__).resolve().parent

        # ä¼šè¯ç®¡ç†
        self.session_id = f"dual-{int(time.time())}-{os.getpid()}"
        self.runtime_dir = Path("/tmp") / f"codex-{getpass.getuser()}" / self.session_id
        self.runtime_dir.mkdir(parents=True, exist_ok=True)

        # æ–‡ä»¶è·¯å¾„
        self.input_fifo = self.runtime_dir / "input.fifo"
        self.output_fifo = self.runtime_dir / "output.fifo"
        self.codex_pid_file = self.runtime_dir / "codex.pid"
        self.claude_pid_file = self.runtime_dir / "claude.pid"
        self.status_file = self.runtime_dir / "status"
        self.project_session_file = Path.cwd() / ".codex-session"

        # è¿›ç¨‹ç®¡ç†
        self.codex_process = None
        self.tmux_session = f"codex-{self.session_id[:8]}"

    def create_fifos(self):
        """åˆ›å»ºFIFOç®¡é“"""
        print("ğŸ”§ åˆ›å»ºé€šä¿¡ç®¡é“...")

        try:
            # åˆ›å»ºè¾“å…¥ç®¡é“ (Claude â†’ Codex)
            if not self.input_fifo.exists():
                os.mkfifo(self.input_fifo)
            os.chmod(self.input_fifo, 0o600)

            # åˆ›å»ºè¾“å‡ºç®¡é“ (Codex â†’ Claude ç›‘æ§)
            if not self.output_fifo.exists():
                os.mkfifo(self.output_fifo)
            os.chmod(self.output_fifo, 0o644)

            print(f"âœ… ç®¡é“åˆ›å»ºå®Œæˆ:")
            print(f"   è¾“å…¥: {self.input_fifo}")
            print(f"   è¾“å‡º: {self.output_fifo}")
            return True

        except Exception as e:
            print(f"âŒ åˆ›å»ºç®¡é“å¤±è´¥: {e}")
            return False

    def start_tmux_codex(self):
        """ä½¿ç”¨tmuxå¯åŠ¨Codexçª—å£"""
        print("ğŸš€ å¯åŠ¨Codexçª—å£ï¼ˆtmuxæ¨¡å¼ï¼‰...")

        # åˆ›å»ºCodexå¯åŠ¨è„šæœ¬
        codex_script = f'''#!/bin/bash
# Codex tmuxä¼šè¯å¯åŠ¨è„šæœ¬

SESSION_ID="{self.session_id}"
RUNTIME_DIR="{self.runtime_dir}"
PID_FILE="{self.codex_pid_file}"

echo $$ > "$PID_FILE"
echo "ğŸ¤– Codexä¼šè¯å¯åŠ¨: $SESSION_ID"
echo "ğŸ“ è¿è¡Œç›®å½•: $RUNTIME_DIR"
echo ""
echo "ğŸ”§ æç¤ºï¼š"
echo "- è¿™æ˜¯Codexçª—å£ï¼Œå¯ä»¥ç›´æ¥ä¸Codexå¯¹è¯"
echo "- Claudeå¯ä»¥é€šè¿‡/codex-askå‘½ä»¤å‘é€é—®é¢˜åˆ°è¿™é‡Œ"
echo "- è¾“å…¥ 'exit' é€€å‡ºCodex"
echo ""

# æ£€æŸ¥codexæ˜¯å¦å¯ç”¨
if ! command -v codex &> /dev/null; then
    echo "âŒ é”™è¯¯ï¼šæ‰¾ä¸åˆ°codexå‘½ä»¤"
    echo "è¯·ç¡®ä¿å·²å®‰è£…codex CLIå·¥å…·"
    sleep 5
    exit 1
fi

# å¯åŠ¨codex
exec codex
'''

        # å†™å…¥è„šæœ¬æ–‡ä»¶
        script_file = self.runtime_dir / "codex_tmux.sh"
        with open(script_file, 'w') as f:
            f.write(codex_script)
        os.chmod(script_file, 0o755)

        try:
            # æ£€æŸ¥tmuxæ˜¯å¦å¯ç”¨
            result = subprocess.run(["tmux", "has-session"], capture_output=True)
            if result.returncode == 0 and self.tmux_session in result.stderr.decode():
                print(f"âš ï¸ tmuxä¼šè¯ {self.tmux_session} å·²å­˜åœ¨")
                return False

            # åˆ›å»ºæ–°çš„tmuxä¼šè¯
            print(f"ğŸ“º åˆ›å»ºtmuxä¼šè¯: {self.tmux_session}")
            cmd = [
                "tmux", "new-session", "-d", "-s", self.tmux_session,
                str(script_file)
            ]
            result = subprocess.run(cmd, capture_output=True, text=True)

            if result.returncode != 0:
                print(f"âŒ åˆ›å»ºtmuxä¼šè¯å¤±è´¥: {result.stderr}")
                return False

            print(f"âœ… tmuxä¼šè¯åˆ›å»ºæˆåŠŸ")
            print(f"ğŸ’¡ æç¤ºï¼šä½¿ç”¨ 'tmux attach -t {self.tmux_session}' è¿æ¥åˆ°Codexçª—å£")
            return True

        except FileNotFoundError:
            print("âŒ tmuxæœªå®‰è£…ï¼Œè¯·å…ˆå®‰è£…tmux")
            print("   Ubuntu/Debian: sudo apt install tmux")
            print("   CentOS/RHEL: sudo yum install tmux")
            return False
        except Exception as e:
            print(f"âŒ å¯åŠ¨tmuxå¤±è´¥: {e}")
            return False

    def start_claude_window(self):
        """å¯åŠ¨Claudeçª—å£"""
        print("ğŸš€ å¯åŠ¨Claudeçª—å£...")

        # ä¿å­˜ä¼šè¯ä¿¡æ¯
        try:
            with open(self.project_session_file, 'w') as f:
                session_info = {
                    "session_id": self.session_id,
                    "runtime_dir": str(self.runtime_dir),
                    "tmux_session": self.tmux_session,
                    "started_at": time.strftime('%Y-%m-%d %H:%M:%S')
                }
                json.dump(session_info, f, indent=2)
            print(f"âœ… ä¼šè¯ä¿¡æ¯å·²ä¿å­˜: {self.project_session_file}")
        except Exception as e:
            print(f"âš ï¸ ä¿å­˜ä¼šè¯ä¿¡æ¯å¤±è´¥: {e}")

        # å†™å…¥Claude PID
        with open(self.claude_pid_file, 'w') as f:
            f.write(str(os.getpid()))

        # æ›´æ–°çŠ¶æ€
        with open(self.status_file, 'w') as f:
            f.write("running")

        print(f"ğŸ“‹ ä¼šè¯ID: {self.session_id}")
        print(f"ğŸ“º tmuxä¼šè¯: {self.tmux_session}")
        print(f"ğŸ“ è¿è¡Œç›®å½•: {self.runtime_dir}")
        print("âœ… Claudeçª—å£å°±ç»ª")
        print()
        print("ğŸ¯ å¯ç”¨å‘½ä»¤:")
        print("   /codex-ask <é—®é¢˜>              - å¼‚æ­¥å‘é€é—®é¢˜")
        print("   /codex-ask --wait <é—®é¢˜>       - åŒæ­¥ç­‰å¾…å›å¤")
        print("   /codex-status                  - æŸ¥çœ‹è¿æ¥çŠ¶æ€")
        print("   /codex-ping                    - æµ‹è¯•è¿é€šæ€§")
        print()
        print(f"ğŸ’¡ è¿æ¥åˆ°Codexçª—å£: tmux attach -t {self.tmux_session}")
        print()

        # è®¾ç½®ç¯å¢ƒå˜é‡
        env = os.environ.copy()
        env["CODEX_SESSION_ID"] = self.session_id
        env["CODEX_RUNTIME_DIR"] = str(self.runtime_dir)
        env["CODEX_INPUT_FIFO"] = str(self.input_fifo)
        env["CODEX_OUTPUT_FIFO"] = str(self.output_fifo)
        env["CODEX_TMUX_SESSION"] = self.tmux_session

        try:
            # å¯åŠ¨Claude Code
            cmd = ["claude"] + self.claude_args
            print(f"æ‰§è¡Œ: {' '.join(cmd)}")

            return subprocess.run(
                cmd,
                stdin=sys.stdin,
                stdout=sys.stdout,
                stderr=sys.stderr,
                env=env
            ).returncode

        except KeyboardInterrupt:
            print("\nâš ï¸ ç”¨æˆ·ä¸­æ–­")
            return 130
        except Exception as e:
            print(f"âŒ å¯åŠ¨Claudeå¤±è´¥: {e}")
            return 1

    def cleanup(self):
        """æ¸…ç†èµ„æº"""
        print("\nğŸ§¹ æ¸…ç†ä¼šè¯èµ„æº...")

        try:
            # æ€æ‰tmuxä¼šè¯
            result = subprocess.run(
                ["tmux", "has-session", "-t", self.tmux_session],
                capture_output=True
            )
            if result.returncode == 0:
                subprocess.run([
                    "tmux", "kill-session", "-t", self.tmux_session
                ], stderr=subprocess.DEVNULL)
                print(f"âœ… tmuxä¼šè¯å·²æ¸…ç†: {self.tmux_session}")

            # åˆ é™¤è¿è¡Œæ—¶ç›®å½•
            import shutil
            if self.runtime_dir.exists():
                shutil.rmtree(self.runtime_dir)

            # åˆ é™¤é¡¹ç›®ä¼šè¯æ–‡ä»¶
            if self.project_session_file.exists():
                self.project_session_file.unlink()

            print("âœ… æ¸…ç†å®Œæˆ")

        except Exception as e:
            print(f"âš ï¸ æ¸…ç†æ—¶å‡ºç°é”™è¯¯: {e}")

    def run(self):
        """ä¸»è¿è¡Œæµç¨‹"""
        print(f"ğŸš€ Claude-Codex åŒçª—å£æ¨¡å¼ (tmux)")
        print(f"ğŸ“… å¯åŠ¨æ—¶é—´: {time.strftime('%Y-%m-%d %H:%M:%S')}")
        print(f"ğŸ†” ä¼šè¯ID: {self.session_id}")
        print("=" * 50)

        # æ³¨å†Œæ¸…ç†å‡½æ•°
        atexit.register(self.cleanup)
        signal.signal(signal.SIGINT, lambda s, f: (self.cleanup(), sys.exit(0)))
        signal.signal(signal.SIGTERM, lambda s, f: (self.cleanup(), sys.exit(0)))

        # åˆ›å»ºç®¡é“
        if not self.create_fifos():
            return 1

        # å¯åŠ¨Codexçª—å£
        if not self.start_tmux_codex():
            return 1

        # ç­‰å¾…Codexå¯åŠ¨
        time.sleep(2)

        try:
            # å¯åŠ¨Claudeçª—å£
            return self.start_claude_window()
        finally:
            self.cleanup()

def show_help():
    """æ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯"""
    help_text = """
claude-codex-dual-simple - Claude-Codex åŒçª—å£æ¨¡å¼ (tmuxç‰ˆ)

ç”¨æ³•:
    claude-codex-dual-simple [OPTIONS] [COMMAND] [ARGS]...

åŠŸèƒ½:
    ğŸš€ ä½¿ç”¨tmuxå¯åŠ¨Claudeå’ŒCodexä¸¤ä¸ªçª—å£
    ğŸ”— å»ºç«‹Claudeåˆ°Codexçš„å•å‘æ§åˆ¶é€šé“
    ğŸ’¾ è‡ªåŠ¨ä¿å­˜ä¼šè¯ä¿¡æ¯å’Œå†å²è®°å½•
    ğŸ”„ æ”¯æŒä¸­æ–­æ¢å¤å’Œé”™è¯¯å¤„ç†

ç‰¹ç‚¹:
    - ä½¿ç”¨tmuxç¡®ä¿æœ€ä½³å…¼å®¹æ€§
    - ç®€åŒ–çš„å¯åŠ¨æµç¨‹
    - ç¨³å®šçš„ä¼šè¯ç®¡ç†

ç¤ºä¾‹:
    claude-codex-dual-simple                           # å¯åŠ¨åŒçª—å£æ¨¡å¼
    claude-codex-dual-simple --resume                  # æ¢å¤ä¸Šæ¬¡ä¼šè¯
    claude-codex-dual-simple /path/to/project          # åœ¨é¡¹ç›®ç›®å½•å¯åŠ¨

Claudeå‘½ä»¤ (åœ¨Claudeçª—å£ä¸­ä½¿ç”¨):
    /codex-ask <é—®é¢˜>              - å¼‚æ­¥å‘é€é—®é¢˜åˆ°Codex
    /codex-ask --wait <é—®é¢˜>       - åŒæ­¥ç­‰å¾…Codexå›å¤
    /codex-status                  - æŸ¥çœ‹è¿æ¥çŠ¶æ€
    /codex-ping                    - æµ‹è¯•è¿é€šæ€§

tmuxå‘½ä»¤:
    tmux attach -t codex-xxxx     # è¿æ¥åˆ°Codexçª—å£
    tmux list-sessions            # æŸ¥çœ‹æ‰€æœ‰ä¼šè¯
    tmux kill-session -t codex-xxxx # åˆ é™¤Codexä¼šè¯
"""
    print(help_text)

def main():
    parser = argparse.ArgumentParser(add_help=False)
    parser.add_argument('--resume', action='store_true', help='æ¢å¤ä¸Šæ¬¡çš„ä¼šè¯')
    parser.add_argument('--help', '-h', action='store_true', help='æ˜¾ç¤ºå¸®åŠ©')

    args, claude_args = parser.parse_known_args()

    if args.help:
        show_help()
        return 0

    dual = SimpleClaudeCodexDual(resume=args.resume, claude_args=claude_args)
    return dual.run()

if __name__ == "__main__":
    sys.exit(main())