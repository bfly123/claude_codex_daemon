#!/usr/bin/env python3
"""
cast å‘½ä»¤
å°† Claude ä¸­çš„åŽŸå§‹è¾“å…¥è½¬å‘åˆ° Codex tmux ä¼šè¯ï¼Œå¹¶è§¦å‘æ‰§è¡Œã€‚
"""

from __future__ import annotations

import json
import os
import subprocess
import sys
import time
from pathlib import Path
from typing import Optional, Tuple


def _usage() -> None:
    print("ç”¨æ³•: cast <åŽŸå§‹æŒ‡ä»¤>", file=sys.stderr)
    print('ç¤ºä¾‹: cast "/cask è§£é‡Šä¸€ä¸‹å½“å‰è„šæœ¬ä½œç”¨"', file=sys.stderr)


def _load_session_from_env() -> Optional[Tuple[str, Optional[str]]]:
    session = os.environ.get("CODEX_TMUX_SESSION")
    runtime = os.environ.get("CODEX_RUNTIME_DIR")
    if session:
        return session, runtime
    return None


def _load_session_from_file() -> Optional[Tuple[str, Optional[str]]]:
    project_file = Path.cwd() / ".codex-session"
    if not project_file.exists():
        return None

    try:
        data = json.loads(project_file.read_text(encoding="utf-8"))
    except Exception as exc:
        print(f"âŒ æ— æ³•è§£æž .codex-session: {exc}", file=sys.stderr)
        return None

    if not isinstance(data, dict):
        return None
    if not data.get("active"):
        return None

    session = data.get("tmux_session")
    runtime = data.get("runtime_dir")
    if not session:
        return None
    return str(session), str(runtime) if runtime else None


def _resolve_tmux_session() -> Tuple[str, Optional[str]]:
    info = _load_session_from_env()
    if info:
        return info
    info = _load_session_from_file()
    if info:
        return info
    raise RuntimeError("âŒ æœªæ‰¾åˆ° Codex ä¼šè¯ï¼Œè¯·å…ˆè¿è¡Œ claude_codex")


def _ensure_tmux_session(session: str) -> None:
    result = subprocess.run(
        ["tmux", "has-session", "-t", session],
        stdout=subprocess.DEVNULL,
        stderr=subprocess.DEVNULL,
    )
    if result.returncode != 0:
        raise RuntimeError(f"âŒ tmux ä¼šè¯ä¸å­˜åœ¨: {session}\næç¤º: è¯·ç¡®è®¤ claude_codex æ­£åœ¨è¿è¡Œ")


def _send_via_tmux(session: str, payload: str) -> None:
    sanitized = payload.replace("\r", "").strip()
    if not sanitized:
        raise RuntimeError("âŒ ä¼ å…¥çš„æŒ‡ä»¤ä¸ºç©º")

    buffer_name = f"cast-{os.getpid()}-{int(time.time() * 1000)}"
    payload_with_newline = sanitized + "\n"
    encoded = payload_with_newline.encode("utf-8")

    subprocess.run(
        ["tmux", "load-buffer", "-b", buffer_name, "-"],
        input=encoded,
        check=True,
    )
    subprocess.run(
        ["tmux", "paste-buffer", "-t", session, "-b", buffer_name, "-p"],
        check=True,
    )
    subprocess.run(
        ["tmux", "send-keys", "-t", session, "Enter"],
        check=True,
    )
    subprocess.run(
        ["tmux", "delete-buffer", "-b", buffer_name],
        stderr=subprocess.DEVNULL,
    )


def main(argv: list[str]) -> int:
    if len(argv) <= 1:
        _usage()
        return 1

    raw_command = " ".join(argv[1:])
    if not raw_command.strip():
        _usage()
        return 1

    try:
        session, runtime = _resolve_tmux_session()
        _ensure_tmux_session(session)
        _send_via_tmux(session, raw_command)
        location = runtime or "tmux"
        print(f"âœ… å·²å‘é€åˆ° Codex ä¼šè¯ ({session})")
        print(f"ðŸ“ è¿è¡Œç›®å½•: {location}")
        return 0
    except subprocess.CalledProcessError as exc:
        print(f"âŒ tmux æ‰§è¡Œå¤±è´¥: {exc}", file=sys.stderr)
        return exc.returncode or 1
    except RuntimeError as exc:
        print(exc, file=sys.stderr)
        return 1


if __name__ == "__main__":
    raise SystemExit(main(sys.argv))
