#!/usr/bin/env python3
"""
gask-w - åŒæ­¥å‘é€æ¶ˆæ¯åˆ° Gemini å¹¶ç­‰å¾…å›å¤
"""

from __future__ import annotations

import sys
import time
from pathlib import Path

script_dir = Path(__file__).resolve().parent
lib_dir = script_dir.parent / "lib"
sys.path.insert(0, str(lib_dir))

from gemini_comm import GeminiCommunicator


def main(argv: list[str]) -> int:
    if len(argv) <= 1:
        print("ç”¨æ³•: gask-w <æ¶ˆæ¯>", file=sys.stderr)
        return 1

    message = " ".join(argv[1:]).strip()
    if not message:
        print("âŒ æ¶ˆæ¯å†…å®¹ä¸èƒ½ä¸ºç©º", file=sys.stderr)
        return 1

    try:
        comm = GeminiCommunicator()
        state = comm.log_reader.capture_state()

        print(f"ğŸ”” å‘é€åˆ° Gemini: {message[:50]}{'...' if len(message) > 50 else ''}")
        comm._send_via_terminal(message)

        print("â³ ç­‰å¾… Gemini å›å¤...")
        start_time = time.time()
        last_hint = 0

        while True:
            reply, new_state = comm.log_reader.wait_for_message(state, timeout=1.0)
            if reply:
                print("\nğŸ¤– Gemini å›å¤:")
                print(reply)
                return 0
            state = new_state if new_state else state

            elapsed = int(time.time() - start_time)
            if elapsed >= last_hint + 30:
                last_hint = elapsed
                print(f"â³ ä»åœ¨ç­‰å¾… Gemini å›å¤... ({elapsed}s)")

    except Exception as exc:
        print(f"âŒ {exc}", file=sys.stderr)
        return 1


if __name__ == "__main__":
    sys.exit(main(sys.argv))
