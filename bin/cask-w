#!/usr/bin/env python3
"""
cask-w - Sync send message to Codex and wait for reply
"""
from __future__ import annotations
import sys
from pathlib import Path

script_dir = Path(__file__).resolve().parent
lib_dir = script_dir.parent / "lib"
sys.path.insert(0, str(lib_dir))


def main(argv: list[str]) -> int:
    if len(argv) <= 1:
        print("Usage: cask-w <message>", file=sys.stderr)
        return 1

    message = " ".join(argv[1:]).strip()
    if not message:
        print("‚ùå Message cannot be empty", file=sys.stderr)
        return 1

    # Early startup signal for background mode detection
    print("üöÄ cask-w started", flush=True)

    # Lazy imports after startup signal
    if sys.platform == "win32":
        from compat import setup_windows_encoding
        setup_windows_encoding()

    from codex_comm import CodexCommunicator

    try:
        comm = CodexCommunicator(lazy_init=True)
        reply = comm.ask_sync(message, timeout=0)
        return 0 if reply else 1

    except Exception as exc:
        print(exc, file=sys.stderr)
        return 1


if __name__ == "__main__":
    raise SystemExit(main(sys.argv))
