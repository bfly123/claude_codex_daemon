#!/usr/bin/env python3
"""
cask-w - åŒæ­¥å‘é€æ¶ˆæ¯åˆ° Codex å¹¶ç­‰å¾…å›å¤
"""
from __future__ import annotations
import sys
import time
from pathlib import Path

script_dir = Path(__file__).resolve().parent
lib_dir = script_dir.parent / "lib"
sys.path.insert(0, str(lib_dir))

from codex_comm import CodexCommunicator
from terminal import get_backend_for_session, get_pane_id_from_session

import importlib.util
import importlib.machinery


def _usage() -> None:
    print("ç”¨æ³•: cask-w <æ¶ˆæ¯>", file=sys.stderr)


def _load_cask_module():
    cask_path = script_dir / "cask"
    spec = importlib.util.spec_from_loader("cask", importlib.machinery.SourceFileLoader("cask", str(cask_path)))
    module = importlib.util.module_from_spec(spec)
    spec.loader.exec_module(module)
    return module


def main(argv: list[str]) -> int:
    if len(argv) <= 1:
        _usage()
        return 1

    message = " ".join(argv[1:]).strip()
    if not message:
        _usage()
        return 1

    try:
        cask = _load_cask_module()
        data, pane_id = cask._resolve_session()
        backend = get_backend_for_session(data)

        if not backend or not backend.is_alive(pane_id):
            raise RuntimeError("âŒ Codex ä¼šè¯ä¸å­˜åœ¨")

        comm = CodexCommunicator()
        state = comm.log_reader.capture_state()

        backend.send_text(pane_id, message)
        print("â³ ç­‰å¾… Codex å›å¤...")

        start = time.time()
        last_hint = 0
        while True:
            reply, new_state = comm.log_reader.wait_for_message(state, timeout=1.0)
            if reply:
                print("\nğŸ¤– Codex å›å¤:")
                print(reply)
                return 0
            state = new_state or state
            elapsed = int(time.time() - start)
            if elapsed >= last_hint + 30:
                last_hint = elapsed
                print(f"â³ ä»åœ¨ç­‰å¾…... ({elapsed}s)")

    except Exception as exc:
        print(exc, file=sys.stderr)
        return 1


if __name__ == "__main__":
    raise SystemExit(main(sys.argv))
