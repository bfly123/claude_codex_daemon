#!/bin/bash
# Claude-Codex 双窗口模式 status命令简化版

SCRIPT_DIR="/home/bfly/运维/基本问题"

# 检查是否有活动会话
if [ ! -f "./.codex-session" ]; then
    echo "❌ 未找到活动会话，请先启动双窗口模式"
    echo "💡 启动命令: $SCRIPT_DIR/claude-codex-dual-simple"
    exit 1
fi

# 读取会话信息
echo "📊 Claude-Codex 双窗口状态:"
echo "================================"

SESSION_INFO=$(cat "./.codex-session")
SESSION_ID=$(echo "$SESSION_INFO" | python3 -c "import sys, json; print(json.load(sys.stdin)['session_id'])")
RUNTIME_DIR="/tmp/codex-bfly/$SESSION_ID"
PID_FILE="$RUNTIME_DIR/codex.pid"
INPUT_FIFO="$RUNTIME_DIR/input.fifo"
OUTPUT_FIFO="$RUNTIME_DIR/output.fifo"
TMUX_SESSION=$(echo "$SESSION_INFO" | python3 -c "import sys, json; data=json.load(sys.stdin); print(data.get('tmux_session', 'unknown'))")
STARTED_AT=$(echo "$SESSION_INFO" | python3 -c "import sys, json; print(json.load(sys.stdin).get('started_at', 'unknown'))")

echo "会话信息:"
echo "   ID: $SESSION_ID"
echo "   启动时间: $STARTED_AT"
echo "   运行目录: $RUNTIME_DIR"
echo "   tmux会话: $TMUX_SESSION"
echo

echo "文件状态:"
if [ -f "$PID_FILE" ]; then
    echo "   ✅ PID文件存在: $PID_FILE"
    PID=$(cat "$PID_FILE")
    if kill -0 "$PID" 2>/dev/null; then
        echo "   ✅ Codex进程运行中 (PID: $PID)"
    else
        echo "   ❌ Codex进程已停止"
    fi
else
    echo "   ❌ PID文件不存在"
fi

if [ -p "$INPUT_FIFO" ]; then
    echo "   ✅ 输入管道存在: $INPUT_FIFO"
else
    echo "   ❌ 输入管道不存在"
fi

if [ -p "$OUTPUT_FIFO" ]; then
    echo "   ✅ 输出管道存在: $OUTPUT_FIFO"
else
    echo "   ❌ 输出管道不存在"
fi

echo

echo "tmux状态:"
if tmux has-session -t "$TMUX_SESSION" 2>/dev/null; then
    echo "   ✅ tmux会话运行中"
    echo "   💡 连接命令: tmux attach -t $TMUX_SESSION"
else
    echo "   ❌ tmux会话未运行"
fi

echo
echo "项目文件:"
if [ -f "./.codex-session" ]; then
    echo "   ✅ 会话文件存在: ./.codex-session"
else
    echo "   ❌ 会话文件不存在"
fi

echo "================================"
echo "使用方法:"
echo "   发送问题: $SCRIPT_DIR/dual-ask \"你的问题\""
echo "   测试连接: $SCRIPT_DIR/dual-ping"
echo "   连接Codex: tmux attach -t $TMUX_SESSION"