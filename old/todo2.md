# Claude-Codex 集成方案详细计划

## 🎯 项目目标
解决Claude Code中Codex进程状态管理问题，创建前后端分离的架构：
- **前台**: Claude Code (用户交互)
- **后台**: Codex守护进程 (AI服务)

## 📋 已完成工作

### ✅ 1. Codex守护进程 (codex_daemon.py)
- **功能**: 独立socket服务器，提供持久化AI服务
- **特性**:
  - 支持多客户端连接
  - 完整的信号处理和优雅退出
  - 与现有codex_commands API完全兼容
  - 支持后台运行模式 (`--daemon`)
  - 自动PID文件管理

### ✅ 2. claude-codex包装脚本
- **功能**: 启动Claude Code的同时自动启动Codex守护进程
- **特性**:
  - 完全继承原始claude-code的所有参数
  - 自动进程生命周期管理
  - 智能检测现有守护进程
  - 优雅的启动和清理机制

### ✅ 3. 客户端模式重构 (codex_commands.py)
- **架构**: 从内部进程管理改为socket客户端
- **特性**:
  - 10秒连接超时
  - 完整的参数验证
  - 友好的错误提示
  - 向后兼容接口保持

## 🔧 架构设计

```
用户启动: claude-codex
    ↓
前台: claude-code (用户交互)
    ↓
后台: codex_daemon.py (socket服务器)
    ↓
通信: Unix socket (/tmp/codex-daemon.sock)
    ↓
客户端: codex_commands.py (socket客户端)
```

## 📝 使用流程

### 启动系统
```bash
# 方式1: 直接启动
./claude-codex

# 方式2: 带参数启动
./claude-codex -c "python3 --version"

# 方式3: 打开项目
./claude-codex /path/to/project
```

### Claude中使用
```bash
# 在Claude对话中使用
/codex-ask 你是谁
/codex-config high
/codex-status
/codex-reasoning on
/codex-final_only off
```

## 🚧 待完成任务

### ⏳ 1. 完善守护进程依赖和错误处理
- [ ] 将守护进程拆分为「纯Python前台模式」与「可选daemon化模式」，在缺少依赖时自动降级
- [ ] 整理依赖清单与版本锁定，提供 `requirements-daemon.txt`
- [ ] 添加结构化日志（INFO/ERROR/DEBUG）与轮转策略，输出到 `/tmp/codex-daemon.log`
- [ ] 实现健康检查端点（本地命令 `codex-daemon --health`）与自恢复逻辑
- [ ] 优化Socket重连与指数退避策略，减少Claude端阻塞时间

**优先级**: 高 - 影响系统稳定性

### ⏳ 2. 测试完整集成流程
- [ ] 编写 `tests/test_daemon_integration.py` 模拟完整启动→交互→停止流程
- [ ] 使用 pytest fixture 模拟Claude命令行参数，验证参数透传
- [ ] 针对 `/codex-*` 命令编写回归用例，覆盖成功与失败路径
- [ ] 构建异常场景：Socket丢失、守护进程崩溃、健康检查失败，并验证自动恢复
- [ ] 校验退出流程释放PID/Socket/日志文件，避免遗留孤儿进程

**优先级**: 高 - 验证方案可行性

### ⏳ 3. 创建部署文档和使用指南
- [ ] 编写安装部署文档（本地运行、系统服务、CI环境）
- [ ] 输出常见问题与故障排除清单（健康检查失败、Socket占用、权限问题）
- [ ] 汇总配置选项说明（Socket路径、日志级别、自动重启开关）
- [ ] 添加示例工作流：首次安装、日常使用、升级/回滚步骤
- [ ] 在 `README.md` 与 `.claude/commands/` 中同步新命令及提示

**优先级**: 中 - 提升用户体验

### ⏳ 4. 安全与运维保障
- [ ] 增加Socket与日志文件的权限校验（0600），并在异常时阻止启动
- [ ] 编写守护进程心跳与资源监控脚本，输出到 `todo.md` 追踪
- [ ] 设计数据备份策略，定期归档历史会话（可配置开启）
- [ ] 补充安全公告模板，出现异常时能快速通知使用者

**优先级**: 中 - 确保长期运行可靠

## 🔍 技术细节

### 核心文件
1. **codex_daemon.py** (220行)
   - Unix socket服务器
   - 多线程客户端处理
   - 完整的命令路由

2. **claude-codex** (180行)
   - Python包装脚本
   - 自动进程管理
   - 信号处理机制

3. **codex_commands.py** (167行)
   - Socket客户端
   - 参数验证
   - 错误处理

### 通信协议
```json
// 请求格式
{"command": "/codex-ask", "question": "你是谁"}

// 响应格式
{"success": true, "response": "AI回答内容"}
```

### 配置文件
- Socket路径: `/tmp/codex-daemon.sock`
- PID文件: `/tmp/codex-daemon.pid`
- 日志文件: `/tmp/codex-daemon.log`

## 📊 预期效果

### 用户体验改进
- ✅ **一键启动**: 单个命令启动完整系统
- ✅ **透明集成**: 感受不到架构变化
- ✅ **持久服务**: Codex始终保持热启动
- ✅ **自动管理**: 无需手动进程管理

### 技术优势
- ✅ **状态稳定**: 解决进程状态丢失问题
- ✅ **资源效率**: 单实例服务多客户端
- ✅ **扩展性**: 支持未来功能扩展
- ✅ **维护性**: 清晰的前后端分离

## 🚨 风险和缓解措施

### 潜在风险
1. **依赖问题**: daemon库可能未安装
   - **缓解**: 提供无需daemon的后备方案

2. **Socket冲突**: 多实例可能冲突
   - **缓解**: 智能检测和用户提示

3. **进程僵尸**: 异常退出可能留进程
   - **缓解**: 完善的信号处理和清理

### 测试策略
- 单元测试: 各组件独立测试
- 集成测试: 完整流程验证
- 压力测试: 多客户端并发
- 异常测试: 错误场景处理

## ✅ 验收标准
- **功能完整**: 守护进程可独立运行，Claude端命令全部可用
- **稳定可靠**: 运行 24 小时无资源泄露，自动恢复测试通过
- **可运维**: 日志、健康检查、监控脚本齐备，具备告警能力
- **易部署**: 文档覆盖安装、升级、回滚；提供示例命令与 FAQ
- **安全合规**: 所有临时文件权限合规，无符号链接隐患

## 🧪 测试矩阵
| 场景 | 预期结果 | 工具/脚本 |
| --- | --- | --- |
| 守护进程冷启动 | `codex_daemon` 在 2 秒内监听 Socket | `pytest -k cold_start` |
| 多客户端并发 | 3 个客户端并发请求无阻塞 | `tests/test_daemon_integration.py` |
| 守护进程崩溃 | 自动重启并恢复会话 | 手动 `kill -9`/健康检查 |
| Socket 被占用 | 友好报错并提示清理命令 | `codex_daemon --check` |
| 健康检查失败 | 返回非 0 并输出原因 | `codex_daemon --health` |

## 📦 发布准备
- 准备 `start.sh`/`systemd` 服务模板，便于线上部署
- 写明升级回滚步骤与数据备份目录
- 列出外部依赖与版本，提供离线安装说明
- 制定变更公告流程（含使用影响、回滚窗口）

## 📅 下一步行动计划

### 立即执行 (今天)
1. 完成守护进程后台模式降级与日志增强
2. 搭建基础集成测试骨架并跑通冷启动用例
3. 修复当前已知的Socket连接与清理问题

### 短期目标 (本周)
1. 扩充异常恢复与压力测试覆盖率
2. 输出部署/运维文档初稿并交付评审
3. 打磨健康检查与监控脚本

### 中期目标 (下周)
1. 部署到生产环境
2. 完成用户培训与反馈收集闭环
3. 根据反馈优化性能、补齐监控告警链路

---

**备注**: 此方案解决了Claude Code中Codex进程状态管理的根本问题，通过前后端分离架构实现了稳定的AI服务集成。
