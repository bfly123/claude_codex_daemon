#!/usr/bin/env python3
"""
cast-w å‘½ä»¤
å°†è¾“å…¥è½¬å‘åˆ° Codex tmux ä¼šè¯ï¼Œé»˜è®¤ä½¿ç”¨ /cask-w åŒæ­¥ç­‰å¾…ã€‚
"""

from __future__ import annotations

import importlib.util
import sys
from pathlib import Path
from typing import Tuple


def _usage() -> None:
    print("ç”¨æ³•: cast-w <åŽŸå§‹æŒ‡ä»¤>", file=sys.stderr)
    print('ç¤ºä¾‹: cast-w "è§£é‡Šä¸€ä¸‹å½“å‰è„šæœ¬ä½œç”¨"', file=sys.stderr)


def _load_cast_module():
    script_dir = Path(__file__).resolve().parent
    cast_path = script_dir / "cast"
    if not cast_path.exists():
        raise RuntimeError("âŒ æœªæ‰¾åˆ° cast å‘½ä»¤è„šæœ¬ï¼Œè¯·ç¡®è®¤å®‰è£…æ˜¯å¦å®Œæ•´")

    spec = importlib.util.spec_from_file_location("codex_cast", cast_path)
    if not spec or not spec.loader:
        raise RuntimeError("âŒ æ— æ³•åŠ è½½ cast æ¨¡å—")
    module = importlib.util.module_from_spec(spec)
    spec.loader.exec_module(module)  # type: ignore[attr-defined]
    return module


def _prepare_payload(raw: str) -> str:
    stripped = raw.lstrip()
    if not stripped:
        raise RuntimeError("âŒ æŒ‡ä»¤å†…å®¹ä¸èƒ½ä¸ºç©º")
    if stripped.startswith("/"):
        return raw
    return f"/cask-w {raw}".strip()


def _send(module, payload: str) -> Tuple[str, str]:
    session, runtime = module._resolve_tmux_session()
    module._ensure_tmux_session(session)
    module._send_via_tmux(session, payload)
    location = runtime or "tmux"
    return session, location


def main(argv: list[str]) -> int:
    if len(argv) <= 1:
        _usage()
        return 1

    raw_command = " ".join(argv[1:])
    if not raw_command.strip():
        _usage()
        return 1

    try:
        module = _load_cast_module()
        payload = _prepare_payload(raw_command)
        session, location = _send(module, payload)
        print(f"âœ… å·²å‘é€åˆ° Codex ä¼šè¯ ({session})")
        print(f"ðŸ“ è¿è¡Œç›®å½•: {location}")
        return 0
    except Exception as exc:
        print(exc, file=sys.stderr)
        return 1


if __name__ == "__main__":
    raise SystemExit(main(sys.argv))
